name: Docker Image Sync

on:
  push:
    paths:
      - 'images.txt'
    branches:
      - main
  workflow_dispatch:

jobs:
  sync-images:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: æ˜¾ç¤ºé•œåƒåˆ—è¡¨
        run: |
          echo "ğŸ“¦ é•œåƒåŒæ­¥ä»»åŠ¡å¼€å§‹"
          echo "======================================"
          if [ ! -f images.txt ]; then
            echo "âš ï¸  æ²¡æœ‰æ‰¾åˆ° images.txt æ–‡ä»¶"
            exit 0
          fi
          
          echo "ğŸ“‹ éœ€è¦åŒæ­¥çš„é•œåƒåˆ—è¡¨ï¼š"
          echo "---"
          cat images.txt
          echo "---"
      
      - name: åŒæ­¥é•œåƒï¼ˆå¹¶è¡Œå¤„ç†ï¼‰
        run: |
          # è®°å½•å¤±è´¥çš„é•œåƒ
          failed_images=()
          total_images=0
          success_images=0
          
          # å®šä¹‰åŒæ­¥é•œåƒçš„å‡½æ•°
          sync_image() {
            local line="$1"
            local image_name="$2"
            local tag="$3"
            local image_basename="$4"
            local target_image="$5"
            
            echo "[$(date '+%H:%M:%S')] ğŸš€ å¼€å§‹åŒæ­¥: $line"
            
            # æ‹‰å–æºé•œåƒ
            if ! docker pull "$line" > /dev/null 2>&1; then
              echo "[$(date '+%H:%M:%S')] âŒ æ‹‰å–å¤±è´¥: $line"
              return 1
            fi
            
            # æ ‡è®°é•œåƒ
            if ! docker tag "$line" "$target_image" > /dev/null 2>&1; then
              echo "[$(date '+%H:%M:%S')] âŒ æ ‡è®°å¤±è´¥: $target_image"
              return 1
            fi
            
            # æ¨é€é•œåƒ
            if ! docker push "$target_image" > /dev/null 2>&1; then
              echo "[$(date '+%H:%M:%S')] âŒ æ¨é€å¤±è´¥: $target_image"
              return 1
            fi
            
            echo "[$(date '+%H:%M:%S')] âœ… æˆåŠŸåŒæ­¥: $target_image"
            return 0
          }
          
          # è®¡ç®—æ€»é•œåƒæ•°
          while IFS= read -r line; do
            line=$(echo "$line" | xargs)
            if [ -n "$line" ] && [[ ! "$line" =~ ^# ]]; then
              ((total_images++))
            fi
          done < images.txt
          
          echo ""
          echo "ğŸ“Š æ€»å…±éœ€è¦åŒæ­¥: $total_images ä¸ªé•œåƒ"
          echo "âš¡ å¼€å§‹å¹¶è¡Œå¤„ç†..."
          echo ""
          
          # å¹¶è¡Œå¤„ç†é•œåƒ
          while IFS= read -r line; do
            line=$(echo "$line" | xargs)  # å»é™¤é¦–å°¾ç©ºæ ¼
            if [ -z "$line" ] || [[ "$line" =~ ^# ]]; then
              continue  # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            fi
            
            # æå–ä»“åº“ã€å‘½åç©ºé—´å’Œæ ‡ç­¾
            if [[ $line =~ (.+):([^:]+)$ ]]; then
              image_name="${BASH_REMATCH[1]}"
              tag="${BASH_REMATCH[2]}"
            else
              image_name="$line"
              tag="latest"
            fi
            
            # æå–é•œåƒåç§°ï¼ˆå»é™¤ä»“åº“éƒ¨åˆ†ï¼‰
            image_basename=$(basename "$image_name")
            
            # ç›®æ ‡é•œåƒåç§°
            target_image="${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_NAMESPACE }}/${image_basename}:${tag}"
            
            # åå°æ‰§è¡ŒåŒæ­¥ä»»åŠ¡
            (
              if sync_image "$line" "$image_name" "$tag" "$image_basename" "$target_image"; then
                echo "$line" >> /tmp/success_images.txt
              else
                echo "$line â†’ $target_image" >> /tmp/failed_images.txt
              fi
            ) &
            
          done < images.txt
          
          # ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡å®Œæˆ
          wait
          
          echo ""
          echo "======================================"
          echo "ğŸ“ˆ å¹¶è¡Œä»»åŠ¡æ‰§è¡Œå®Œæˆ"
          echo "======================================"
      
      - name: æ¸…ç† Docker é•œåƒ
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç† Docker é•œåƒç¼“å­˜"
          docker system prune -af --volumes || true
          
      - name: æ˜¾ç¤ºåŒæ­¥ç»“æœ
        if: always()
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ“Š åŒæ­¥ç»“æœç»Ÿè®¡"
          echo "======================================"
          
          # è¯»å–æˆåŠŸå’Œå¤±è´¥çš„é•œåƒåˆ—è¡¨
          success_count=0
          failed_count=0
          
          if [ -f /tmp/success_images.txt ]; then
            success_count=$(wc -l < /tmp/success_images.txt | xargs)
            echo ""
            echo "âœ… æˆåŠŸçš„æ•°é‡: $success_count"
            if [ "$success_count" -gt 0 ]; then
              echo "å…·ä½“æˆåŠŸçš„ä¸ºï¼š"
              while IFS= read -r line; do
                echo "  âœ“ $line"
              done < /tmp/success_images.txt
            fi
          else
            echo ""
            echo "âœ… æˆåŠŸçš„æ•°é‡: 0"
          fi
          
          if [ -f /tmp/failed_images.txt ]; then
            failed_count=$(wc -l < /tmp/failed_images.txt | xargs)
            echo ""
            echo "âŒ å¤±è´¥çš„æ•°é‡: $failed_count"
            if [ "$failed_count" -gt 0 ]; then
              echo "å…·ä½“å¤±è´¥çš„ä¸ºï¼š"
              while IFS= read -r line; do
                echo "  âœ— $line"
              done < /tmp/failed_images.txt
            fi
          else
            echo ""
            echo "âŒ å¤±è´¥çš„æ•°é‡: 0"
          fi
          
          echo ""
          echo "======================================"
          echo "ğŸ‰ æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ"
          echo "======================================"
          
          # å¦‚æœæ‰€æœ‰é•œåƒéƒ½å¤±è´¥ï¼Œåˆ™é€€å‡º
          if [ -f /tmp/failed_images.txt ] && [ ! -f /tmp/success_images.txt ]; then
            exit 1
          fi

